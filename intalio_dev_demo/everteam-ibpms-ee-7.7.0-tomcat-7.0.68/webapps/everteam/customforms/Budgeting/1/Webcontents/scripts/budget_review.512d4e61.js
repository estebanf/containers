$(function(){var a=function(a,b,c){$.ajax({type:"POST",url:a,data:JSON.stringify(b),headers:{"Content-Type":"application/json/badgerfish"},error:function(a,b,c){console.log(c)},success:c})},b=new WorkflowClient;b.token||$("#tokenProblem").modal();var c={},d=b.getTask(),e=_.template($("#department-template").html());d.then(function(b){c=b["tms:getTaskResponse"]["tms:task"]["tms:input"];var d=function(a){var b=a.parents("tr");update=b.data();var c=b.find("input[type='checkbox']").is(":checked")?"true":"false";$("#submit").prop("disabled",!0).text("Loading"),$.ajax({type:"POST",url:"/intalio/ode/processes/Budgeting/Processes/Integrations/ProjectReviewAPI/process/caller",data:JSON.stringify({"proc:update_projectRequest":{"@xmlns":{proc:"http://budgeting.example.everteam.com/Processes/Integrations/ProjectReviewAPI/process",bus:"http://budgeting.example.everteam.com/Types/Business",tec:"http://budgeting.example.everteam.com/Types/Technical"},"tec:project":{"bus:ExcerciseId":{$:update.ExcerciseId},"bus:DepartmentId":{$:update.DepartmentId},"bus:ProjectId":{$:update.ProjectId}},"tec:budget":{$:update.budget},"tec:priority":{$:update.priority},"tec:included":{$:"true"},"tec:approved":{$:c+""}}}),headers:{"Content-Type":"application/json/badgerfish"},error:function(a,b,c){console.log(c)},success:function(){$("#submit").prop("disabled",!1).text("Submit")}})},f={"proc:Recieve_requestRequest":{"@xmlns":{proc:"http://budgeting.example.everteam.com/Processes/Integrations/GetDepartments/process"},$:""}};a("/intalio/ode/processes/Budgeting/Processes/Integrations/GetDepartments/process/Caller",f,function(c){console.log(c),_.each(c.Recieve_requestResponse["tns:Department"],function(c){var f={"proc:Get_projectsRequest":{"@xmlns":{proc:"http://budgeting.example.everteam.com/Processes/Integrations/ProjectReviewAPI/process",bus:"http://budgeting.example.everteam.com/Types/Business"},"bus:DepartmentId":{$:c["tns:DepartmentId"].$},"bus:ExcerciseId":{$:b["tms:getTaskResponse"]["tms:task"]["tms:input"].ProjectDepartmentIdentifier.ExcerciseId.$}}};a("/intalio/ode/processes/Budgeting/Processes/Integrations/ProjectReviewAPI/process/caller",f,function(a){a=a.Get_projectsResponse,$("#fiscal_year").text(a["Technical:Variables"]["tns:fiscal_year"].$),$("#expected_increase").text(a["Technical:Variables"]["tns:ExpectedIncrease"].$),$("#new_investements").text(a["Technical:Variables"]["tns:new_investements"].$),$("#target_approval_date").text(a["Technical:Variables"]["tns:TargetApproval"].$),$("#target_expenses").text(a["Technical:Variables"]["tns:target_expenses"].$),$("#target_submission").text(a["Technical:Variables"]["tns:TargetSubmision"].$),$.isArray(a["Technical:ReviewProjects"])||(a["Technical:ReviewProjects"]=[a["Technical:ReviewProjects"]]);var f=_.map(a["Technical:ReviewProjects"],function(a){return a["Technical:ProjectAttachments"]["Technical:attachment"]&&!$.isArray(a["Technical:ProjectAttachments"]["Technical:attachment"])&&(a["Technical:ProjectAttachments"]["Technical:attachment"]=[a["Technical:ProjectAttachments"]["Technical:attachment"]]),{projectName:a["Technical:Project"]["tns:ProjectName"].$,targetBudget:a["Technical:Project"]["tns:TargetBudget"].$,projectNotes:a["Technical:Project"]["tns:Notes"].$,requested_budget:a["Technical:Requirements"]["tns:Budget"].$,new_project:a["Technical:Requirements"]["tns:NewProject"].$,last_year:a["Technical:Requirements"]["tns:LastYearBudget"].$,description:a["Technical:Requirements"]["tns:Description"].$,justification:a["Technical:Requirements"]["tns:Justification"].$,priority:a["Technical:Requirements"]["tns:Priority"].$,attachments:_.map(a["Technical:ProjectAttachments"]["Technical:attachment"],function(a){return{url:a["Technical:payloadUrl"].$,title:a["Technical:title"].$}})}}),g=$(e({data:{name:c["tns:DeparmentName"].$,projects:f}}));g.find(".projectItem").each(function(d,e){var f={ExcerciseId:b["tms:getTaskResponse"]["tms:task"]["tms:input"].ProjectDepartmentIdentifier.ExcerciseId.$,DepartmentId:c["tns:DepartmentId"].$,ProjectId:a["Technical:ReviewProjects"][d]["Technical:ProjectId"].$,budget:a["Technical:ReviewProjects"][d]["Technical:Requirements"]["tns:Budget"].$,priority:a["Technical:ReviewProjects"][d]["Technical:Requirements"]["tns:Priority"].$};$(e).data(f)}),g.find("input[type='checkbox']").bootstrapSwitch({size:"mini",onSwitchChange:function(){var a=$(this);d(a),a.parents("tr").toggleClass("success").toggleClass("danger")}}),$("#holder").append(g)})})})}),$("#submit").click(function(){b.completeTask(c)})});