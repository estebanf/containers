<?xml version="1.0" encoding="UTF-8"?>
<bpel:process xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable" xmlns:vprop="http://docs.oasis-open.org/wsbpel/2.0/varprop" xmlns:pnlk="http://docs.oasis-open.org/wsbpel/2.0/plnktype" xmlns:wsdl="http://schemas.xmlsoap.org/wsdl/" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ode="http://www.apache.org/ode/type/extension" xmlns:Variables="http://test.com/xvar/example" xmlns:diag="http://budgeting.example.everteam.com/Processes/Integrations/ProjectReviewAPI" xmlns:processimplicitPartner="http://budgeting.example.everteam.com/Processes/Integrations/ProjectReviewAPI/processimplicitPartner" xmlns:caller="http://budgeting.example.everteam.com/Processes/Integrations/ProjectReviewAPI/caller" xmlns:ns="urn:intalio.com:connectors:database:budgeting:select_projectsservice" xmlns:this="http://budgeting.example.everteam.com/Processes/Integrations/ProjectReviewAPI/process" xmlns:tns="http://budgeting.example.everteam.com/Types/Business" xmlns:Technical="http://budgeting.example.everteam.com/Types/Technical" xmlns:GetSingleDepartment-Process="http://budgeting.example.everteam.com/Processes/Integrations/GetSingleDepartment/Process" xmlns:select_project_attachments="urn:intalio.com:connectors:database:budgeting:select_project_attachmentsservice" xmlns:xml="http://www.w3.org/XML/1998/namespace" xmlns:bpmn="http://www.intalio.com/bpms" xmlns:atomic="http://ode.apache.org/atomicScope" queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath2.0" expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath2.0" bpmn:label="process" name="process" bpmn:id="_qjzW0KP_EeWVE9id1dycXQ" targetNamespace="http://budgeting.example.everteam.com/Processes/Integrations/ProjectReviewAPI/process">
  <bpel:import namespace="http://budgeting.example.everteam.com/Processes/Integrations/ProjectReviewAPI" location="ProjectReviewAPI.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
  <bpel:import namespace="http://budgeting.example.everteam.com/Processes/Integrations/ProjectReviewAPI/process" location="ProjectReviewAPI-process.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
  <bpel:import namespace="http://budgeting.example.everteam.com/Processes/Integrations/GetSingleDepartment/Process" location="GetSingleDepartment-Process.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
  <bpel:import namespace="urn:intalio.com:connectors:database:budgeting:select_project_attachmentsservice" location="../../Connectors/Database/select_project_attachments.sql/select_project_attachments.sql.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
  <bpel:import namespace="urn:intalio.com:connectors:database:budgeting:select_projectsservice" location="../../Connectors/Database/select_projects.sql/select_projects.sql.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
  <bpel:import namespace="http://budgeting.example.everteam.com/Types/Technical" location="../../Schemas/Technical.xsd" importType="http://www.w3.org/2001/XMLSchema"></bpel:import>
  <bpel:partnerLinks>
    <bpel:partnerLink name="callerAndProcessPlkVar" partnerLinkType="diag:callerAndProcess" myRole="process_for_caller"/>
    <bpel:partnerLink name="processimplicitPartnerAndProcessForCanonicPortPlkVar" partnerLinkType="diag:processimplicitPartnerAndProcessForCanonicPortPlk" initializePartnerRole="yes" partnerRole="processimplicitPartner_for_process"/>
    <bpel:partnerLink name="processimplicitPartnerAndProcessForSelect_projectsPortPlkVar" partnerLinkType="diag:processimplicitPartnerAndProcessForSelect_projectsPortPlk" initializePartnerRole="yes" partnerRole="processimplicitPartner_for_process"/>
    <bpel:partnerLink name="processimplicitPartnerAndProcessForSelect_project_attachmentsPortPlkVar" partnerLinkType="diag:processimplicitPartnerAndProcessForSelect_project_attachmentsPortPlk" initializePartnerRole="yes" partnerRole="processimplicitPartner_for_process"/>
  </bpel:partnerLinks>
  <bpel:variables>
    <bpel:variable name="thisEventStartMessageRequest1" messageType="this:Get_projectsRequest"/>
    <bpel:variable name="thisUpdate_projectRequest2Msg" messageType="this:update_projectRequest"/>
  </bpel:variables>
  <bpel:pick createInstance="yes" bpmn:label="Exclusive_Event-Based_Gateway" name="Exclusive_Event-Based_Gateway" bpmn:id="_h-aHEKTrEeWVE9id1dycXQ">
    <bpel:onMessage partnerLink="callerAndProcessPlkVar" portType="this:Forcaller" operation="Get_projects" variable="thisEventStartMessageRequest1" bpmn:label="Get projects" name="Get_projects" bpmn:id="_5f3GcKP_EeWVE9id1dycXQ">
      <bpel:sequence>
        <bpel:sequence>
          <bpel:scope bpmn:label="Get projects review" name="Get_projects_review" bpmn:id="_FLdK4KQAEeWVE9id1dycXQ">
            <bpel:variables xmlns:xvar="http://ode.apache.org/externalVariables">
              <bpel:variable name="BudgetingVar-keys" element="Variables:BudgetingVar-keys"/>
              <bpel:variable name="BudgetingVar" element="Variables:BudgetingVar" xvar:id="BudgetingVar-_KEhypqQAEeWVE9id1dycXQ" xvar:relates-to="BudgetingVar-keys"/>
              <bpel:variable name="getSingleDepartment-ProcessRecieve__requestResponse1Msg" messageType="GetSingleDepartment-Process:Recieve__requestResponse"/>
              <bpel:variable name="getSingleDepartment-ProcessRecieve__request1Msg" messageType="GetSingleDepartment-Process:Recieve__requestRequest"/>
              <bpel:variable name="nsSelect_projectsResponse1Msg" messageType="ns:select_projectsOutput"/>
              <bpel:variable name="nsSelect_projectsRequest1Msg" messageType="ns:select_projectsInput"/>
              <bpel:variable name="thisEventStartMessageResponse1" messageType="this:Get_projectsResponse"/>
              <bpel:variable name="Attachments" element="Technical:Attachments"/>
              <bpel:variable name="select_project_attachmentsSelect_project_attachmentsResponse1Msg" messageType="select_project_attachments:select_project_attachmentsOutput"/>
              <bpel:variable name="select_project_attachmentsSelect_project_attachmentsRequest1Msg" messageType="select_project_attachments:select_project_attachmentsInput"/>
            </bpel:variables>
            <bpel:sequence>
              <bpel:assign name="init-variables-Get_projects_review" bpmn:id="_FLdK4KQAEeWVE9id1dycXQ">
                <bpel:copy>
                  <bpel:from>
                    <bpel:literal><Variables:BudgetingVar><Variables:excercise_id/></Variables:BudgetingVar></bpel:literal>
                  </bpel:from>
                  <bpel:to>$BudgetingVar-keys</bpel:to>
                </bpel:copy>
                <bpel:copy bpmn:label="$getSingleDepartment-ProcessRecieve__request1Msg">
                  <bpel:from>
                    <bpel:literal>
<GetSingleDepartment-Process:Recieve__requestRequest></GetSingleDepartment-Process:Recieve__requestRequest></bpel:literal>
                  </bpel:from>
                  <bpel:to>$getSingleDepartment-ProcessRecieve__request1Msg.body</bpel:to>
                </bpel:copy>
                <bpel:copy bpmn:label="$nsSelect_projectsRequest1Msg">
                  <bpel:from>
                    <bpel:literal>
<ns:select_projectsParameterSet>
  <ns:connection>
    <ns:user></ns:user>
    <ns:password></ns:password>
  </ns:connection>
  <ns:execute>
    <ns:parameters>
      <ns:EXCERCISE_ID></ns:EXCERCISE_ID>
      <ns:DEPARTMENTID></ns:DEPARTMENTID>
    </ns:parameters>
  </ns:execute>
</ns:select_projectsParameterSet></bpel:literal>
                  </bpel:from>
                  <bpel:to>$nsSelect_projectsRequest1Msg.parameters</bpel:to>
                </bpel:copy>
                <bpel:copy bpmn:label="$thisEventStartMessageResponse1">
                  <bpel:from>
                    <bpel:literal>
<this:Get_projectsResponse>
  <Technical:Dapartment>
    <tns:DepartmentId></tns:DepartmentId>
    <tns:DeparmentName></tns:DeparmentName>
    <tns:DepartmentDirector></tns:DepartmentDirector>
  </Technical:Dapartment>
  <Technical:Variables>
    <tns:fiscal_year></tns:fiscal_year>
    <tns:target_expenses></tns:target_expenses>
    <tns:ExpectedIncrease></tns:ExpectedIncrease>
    <tns:new_investements>Yes</tns:new_investements>
    <tns:TargetSubmision></tns:TargetSubmision>
    <tns:TargetApproval></tns:TargetApproval>
  </Technical:Variables>
  <Technical:ReviewProjects>
    <Technical:ProjectId></Technical:ProjectId>
    <Technical:Project>
      <tns:ProjectName></tns:ProjectName>
      <tns:ProjectResponsible></tns:ProjectResponsible>
      <tns:TargetBudget></tns:TargetBudget>
      <tns:Notes></tns:Notes>
    </Technical:Project>
    <Technical:Requirements>
      <tns:LastYearBudget></tns:LastYearBudget>
      <tns:Budget></tns:Budget>
      <tns:Priority></tns:Priority>
      <tns:StartExecution></tns:StartExecution>
      <tns:EndExecution></tns:EndExecution>
      <tns:NewProject></tns:NewProject>
      <tns:Description></tns:Description>
      <tns:Justification></tns:Justification>
    </Technical:Requirements>
    <Technical:ProjectAttachments>
      <Technical:attachment>
        <Technical:mimeType></Technical:mimeType>
        <Technical:fileName></Technical:fileName>
        <Technical:title></Technical:title>
        <Technical:description></Technical:description>
        <Technical:creationDate></Technical:creationDate>
        <Technical:payloadUrl></Technical:payloadUrl>
      </Technical:attachment>
    </Technical:ProjectAttachments>
  </Technical:ReviewProjects>
</this:Get_projectsResponse></bpel:literal>
                  </bpel:from>
                  <bpel:to>$thisEventStartMessageResponse1.body</bpel:to>
                </bpel:copy>
                <bpel:copy bpmn:label="$Attachments">
                  <bpel:from>
                    <bpel:literal><Technical:Attachments>
</Technical:Attachments></bpel:literal>
                  </bpel:from>
                  <bpel:to>$Attachments</bpel:to>
                </bpel:copy>
                <bpel:copy bpmn:label="$select_project_attachmentsSelect_project_attachmentsRequest1Msg">
                  <bpel:from>
                    <bpel:literal>
<select_project_attachments:select_project_attachmentsParameterSet>
  <select_project_attachments:connection>
    <select_project_attachments:user></select_project_attachments:user>
    <select_project_attachments:password></select_project_attachments:password>
  </select_project_attachments:connection>
  <select_project_attachments:execute>
    <select_project_attachments:parameters>
      <select_project_attachments:excercise></select_project_attachments:excercise>
      <select_project_attachments:department></select_project_attachments:department>
    </select_project_attachments:parameters>
  </select_project_attachments:execute>
</select_project_attachments:select_project_attachmentsParameterSet></bpel:literal>
                  </bpel:from>
                  <bpel:to>$select_project_attachmentsSelect_project_attachmentsRequest1Msg.parameters</bpel:to>
                </bpel:copy>
              </bpel:assign>
              <bpel:empty bpmn:label="Empty_Start_Event" name="Empty_Start_Event" bpmn:id="_gTJJ4KQAEeWVE9id1dycXQ"/>
              <bpel:flow bpmn:label="Parallel_Gateway" name="Parallel_Gateway" bpmn:id="_h3uiEKQAEeWVE9id1dycXQ">
                <bpel:sequence>
                  <bpel:assign bpmn:label="Locar variables" name="Locar_variables" bpmn:id="_Qqh2QKQAEeWVE9id1dycXQ">
                    <bpel:copy>
                      <bpel:from>$thisEventStartMessageRequest1.body/tns:ExcerciseId</bpel:from>
                      <bpel:to>$BudgetingVar-keys/Variables:excercise_id</bpel:to>
                    </bpel:copy>
                  </bpel:assign>
                </bpel:sequence>
                <bpel:sequence>
                  <bpel:assign bpmn:label="Request single department" name="Request_single_department" bpmn:id="_cIRE5qQAEeWVE9id1dycXQ">
                    <bpel:copy>
                      <bpel:from>$thisEventStartMessageRequest1.body/tns:DepartmentId</bpel:from>
                      <bpel:to>$getSingleDepartment-ProcessRecieve__request1Msg.body</bpel:to>
                    </bpel:copy>
                  </bpel:assign>
                  <bpel:invoke partnerLink="processimplicitPartnerAndProcessForCanonicPortPlkVar" portType="GetSingleDepartment-Process:ForCaller" operation="Recieve__request" inputVariable="getSingleDepartment-ProcessRecieve__request1Msg" outputVariable="getSingleDepartment-ProcessRecieve__requestResponse1Msg" bpmn:label="Request single department" name="Request_single_department-1" bpmn:id="_cIRE5qQAEeWVE9id1dycXQ"></bpel:invoke>
                </bpel:sequence>
                <bpel:sequence>
                  <bpel:assign bpmn:label="Query projects" name="Query_projects" bpmn:id="_Mub-tqQBEeWVE9id1dycXQ">
                    <bpel:copy>
                      <bpel:from>$thisEventStartMessageRequest1.body/tns:DepartmentId</bpel:from>
                      <bpel:to>$nsSelect_projectsRequest1Msg.parameters/ns:execute/ns:parameters/ns:DEPARTMENTID</bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                      <bpel:from>$thisEventStartMessageRequest1.body/tns:ExcerciseId</bpel:from>
                      <bpel:to>$nsSelect_projectsRequest1Msg.parameters/ns:execute/ns:parameters/ns:EXCERCISE_ID</bpel:to>
                    </bpel:copy>
                  </bpel:assign>
                  <bpel:invoke partnerLink="processimplicitPartnerAndProcessForSelect_projectsPortPlkVar" portType="ns:select_projectsPort" operation="select_projects" inputVariable="nsSelect_projectsRequest1Msg" outputVariable="nsSelect_projectsResponse1Msg" bpmn:label="Query projects" name="Query_projects-1" bpmn:id="_Mub-tqQBEeWVE9id1dycXQ"></bpel:invoke>
                  <bpel:assign bpmn:label="Query project attachments" name="Query_project_attachments" bpmn:id="_dXiTZqQLEeWVE9id1dycXQ">
                    <bpel:copy>
                      <bpel:from>$thisEventStartMessageRequest1.body/tns:ExcerciseId</bpel:from>
                      <bpel:to>$select_project_attachmentsSelect_project_attachmentsRequest1Msg.parameters/select_project_attachments:execute/select_project_attachments:parameters/select_project_attachments:excercise</bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                      <bpel:from>$thisEventStartMessageRequest1.body/tns:DepartmentId</bpel:from>
                      <bpel:to>$select_project_attachmentsSelect_project_attachmentsRequest1Msg.parameters/select_project_attachments:execute/select_project_attachments:parameters/select_project_attachments:department</bpel:to>
                    </bpel:copy>
                  </bpel:assign>
                  <bpel:invoke partnerLink="processimplicitPartnerAndProcessForSelect_project_attachmentsPortPlkVar" portType="select_project_attachments:select_project_attachmentsPort" operation="select_project_attachments" inputVariable="select_project_attachmentsSelect_project_attachmentsRequest1Msg" outputVariable="select_project_attachmentsSelect_project_attachmentsResponse1Msg" bpmn:label="Query project attachments" name="Query_project_attachments-1" bpmn:id="_dXiTZqQLEeWVE9id1dycXQ"></bpel:invoke>
                </bpel:sequence>
              </bpel:flow>
              <bpel:assign bpmn:label="Map data" name="Map_data" bpmn:id="_W4ZTcKQQEeWVE9id1dycXQ">
                <bpel:copy>
                  <bpel:from>bpel:doXslTransform("../../XSLT/transform_project_review.xsl", $nsSelect_projectsResponse1Msg.parameters, "attachments", $select_project_attachmentsSelect_project_attachmentsResponse1Msg.parameters)</bpel:from>
                  <bpel:to>$thisEventStartMessageResponse1.body</bpel:to>
                </bpel:copy>
              </bpel:assign>
              <bpel:assign bpmn:label="Reply" name="Reply" bpmn:id="_Ve3SgKQBEeWVE9id1dycXQ">
                <bpel:copy>
                  <bpel:from>$getSingleDepartment-ProcessRecieve__requestResponse1Msg.body</bpel:from>
                  <bpel:to>$thisEventStartMessageResponse1.body/Technical:Dapartment</bpel:to>
                </bpel:copy>
                <bpel:copy>
                  <bpel:from>$BudgetingVar/Variables:fiscal_year</bpel:from>
                  <bpel:to>$thisEventStartMessageResponse1.body/Technical:Variables/tns:fiscal_year</bpel:to>
                </bpel:copy>
                <bpel:copy>
                  <bpel:from>$BudgetingVar/Variables:target_expenses</bpel:from>
                  <bpel:to>$thisEventStartMessageResponse1.body/Technical:Variables/tns:target_expenses</bpel:to>
                </bpel:copy>
                <bpel:copy>
                  <bpel:from>$BudgetingVar/Variables:expected_increase</bpel:from>
                  <bpel:to>$thisEventStartMessageResponse1.body/Technical:Variables/tns:ExpectedIncrease</bpel:to>
                </bpel:copy>
                <bpel:copy>
                  <bpel:from>$BudgetingVar/Variables:new_investments</bpel:from>
                  <bpel:to>$thisEventStartMessageResponse1.body/Technical:Variables/tns:new_investements</bpel:to>
                </bpel:copy>
                <bpel:copy>
                  <bpel:from>$BudgetingVar/Variables:target_submission</bpel:from>
                  <bpel:to>$thisEventStartMessageResponse1.body/Technical:Variables/tns:TargetSubmision</bpel:to>
                </bpel:copy>
                <bpel:copy>
                  <bpel:from>$BudgetingVar/Variables:target_approval</bpel:from>
                  <bpel:to>$thisEventStartMessageResponse1.body/Technical:Variables/tns:TargetApproval</bpel:to>
                </bpel:copy>
              </bpel:assign>
              <bpel:reply partnerLink="callerAndProcessPlkVar" portType="this:Forcaller" operation="Get_projects" variable="thisEventStartMessageResponse1" bpmn:label="Reply" name="Reply-1" bpmn:id="_Ve3SgKQBEeWVE9id1dycXQ"></bpel:reply>
            </bpel:sequence>
          </bpel:scope>
        </bpel:sequence>
      </bpel:sequence>
    </bpel:onMessage>
    <bpel:onMessage partnerLink="callerAndProcessPlkVar" portType="this:Forcaller" operation="update_project" variable="thisUpdate_projectRequest2Msg" bpmn:label="update project" name="update_project" bpmn:id="_nt3kQKTrEeWVE9id1dycXQ">
      <bpel:sequence>
        <bpel:sequence>
          <bpel:scope bpmn:label="SubProcess" name="SubProcess" bpmn:id="_1R2tsKTrEeWVE9id1dycXQ">
            <bpel:variables xmlns:xvar="http://ode.apache.org/externalVariables">
              <bpel:variable name="thisUpdate_projectResponse2Msg" messageType="this:update_projectResponse"/>
              <bpel:variable name="ExcerciseProject-keys" element="Variables:ExcerciseProject-keys"/>
              <bpel:variable name="ExcerciseProject" element="Variables:ExcerciseProject" xvar:id="ExcerciseProject-_47qF8KTrEeWVE9id1dycXQ" xvar:relates-to="ExcerciseProject-keys"/>
            </bpel:variables>
            <bpel:sequence>
              <bpel:assign name="init-variables-SubProcess" bpmn:id="_1R2tsKTrEeWVE9id1dycXQ">
                <bpel:copy bpmn:label="$thisUpdate_projectResponse2Msg">
                  <bpel:from>
                    <bpel:literal>
<this:update_projectResponse>
  <Technical:InstanceId></Technical:InstanceId>
  <Technical:Timestamp></Technical:Timestamp>
</this:update_projectResponse></bpel:literal>
                  </bpel:from>
                  <bpel:to>$thisUpdate_projectResponse2Msg.body</bpel:to>
                </bpel:copy>
                <bpel:copy>
                  <bpel:from>
                    <bpel:literal><Variables:ExcerciseProject><Variables:project_id/><Variables:excercise_id/><Variables:DepartmentId/></Variables:ExcerciseProject></bpel:literal>
                  </bpel:from>
                  <bpel:to>$ExcerciseProject-keys</bpel:to>
                </bpel:copy>
              </bpel:assign>
              <bpel:assign bpmn:label="Update project data" name="Update_project_data" bpmn:id="_v6Pv0KTrEeWVE9id1dycXQ">
                <bpel:copy>
                  <bpel:from>$thisUpdate_projectRequest2Msg.body/Technical:project/tns:ExcerciseId</bpel:from>
                  <bpel:to>$ExcerciseProject-keys/Variables:excercise_id</bpel:to>
                </bpel:copy>
                <bpel:copy>
                  <bpel:from>$thisUpdate_projectRequest2Msg.body/Technical:project/tns:DepartmentId</bpel:from>
                  <bpel:to>$ExcerciseProject-keys/Variables:DepartmentId</bpel:to>
                </bpel:copy>
                <bpel:copy>
                  <bpel:from>$thisUpdate_projectRequest2Msg.body/Technical:project/tns:ProjectId</bpel:from>
                  <bpel:to>$ExcerciseProject-keys/Variables:project_id</bpel:to>
                </bpel:copy>
                <bpel:copy>
                  <bpel:from>$thisUpdate_projectRequest2Msg.body/Technical:budget</bpel:from>
                  <bpel:to>$ExcerciseProject/Variables:Budget</bpel:to>
                </bpel:copy>
                <bpel:copy>
                  <bpel:from>$thisUpdate_projectRequest2Msg.body/Technical:priority</bpel:from>
                  <bpel:to>$ExcerciseProject/Variables:Priority</bpel:to>
                </bpel:copy>
                <bpel:copy>
                  <bpel:from>$thisUpdate_projectRequest2Msg.body/Technical:included</bpel:from>
                  <bpel:to>$ExcerciseProject/Variables:included</bpel:to>
                </bpel:copy>
                <bpel:copy>
                  <bpel:from>$thisUpdate_projectRequest2Msg.body/Technical:approved</bpel:from>
                  <bpel:to>$ExcerciseProject/Variables:approved</bpel:to>
                </bpel:copy>
              </bpel:assign>
              <bpel:assign bpmn:label="Reply" name="Reply-2" bpmn:id="_zFVy0KTrEeWVE9id1dycXQ">
                <bpel:copy>
                  <bpel:from>$ode:pid</bpel:from>
                  <bpel:to>$thisUpdate_projectResponse2Msg.body/Technical:InstanceId</bpel:to>
                </bpel:copy>
                <bpel:copy>
                  <bpel:from>current-dateTime()</bpel:from>
                  <bpel:to>$thisUpdate_projectResponse2Msg.body/Technical:Timestamp</bpel:to>
                </bpel:copy>
              </bpel:assign>
              <bpel:reply partnerLink="callerAndProcessPlkVar" portType="this:Forcaller" operation="update_project" variable="thisUpdate_projectResponse2Msg" bpmn:label="Reply" name="Reply-3" bpmn:id="_zFVy0KTrEeWVE9id1dycXQ"></bpel:reply>
            </bpel:sequence>
          </bpel:scope>
        </bpel:sequence>
      </bpel:sequence>
    </bpel:onMessage>
  </bpel:pick>
</bpel:process>